Timeline._Band=function(timeline,bandInfo,index){var self=this;timeline.autoWidth&&"string"==typeof bandInfo.width&&(bandInfo.width=bandInfo.width.indexOf("%")>-1?0:parseInt(bandInfo.width)),this._timeline=timeline,this._bandInfo=bandInfo,this._index=index,this._locale="locale"in bandInfo?bandInfo.locale:Timeline.getDefaultLocale(),this._timeZone="timeZone"in bandInfo?bandInfo.timeZone:0,this._labeller="labeller"in bandInfo?bandInfo.labeller:"createLabeller"in timeline.getUnit()?timeline.getUnit().createLabeller(this._locale,this._timeZone):new Timeline.GregorianDateLabeller(this._locale,this._timeZone),this._theme=bandInfo.theme,this._zoomIndex="zoomIndex"in bandInfo?bandInfo.zoomIndex:0,this._zoomSteps="zoomSteps"in bandInfo?bandInfo.zoomSteps:null,this._dragging=!1,this._friction="friction"in bandInfo?bandInfo.friction:.95,this._dragSpeed=0,this._changing=!1,this._originalScrollSpeed=5,this._scrollSpeed=this._originalScrollSpeed,this._listeners={},this._listeners.scroll=[],this._listeners.orthogonalscroll=[],this._listeners.dragstart=[],this._listeners.drag=[],this._listeners.dragend=[],this._orthogonalDragging=!1,this._viewOrthogonalOffset=0,this._syncWithBand=null,this._syncWithBandHandler=function(){self._onHighlightBandScroll()},this._syncWithBandOrthogonalScrollHandler=function(){self._onHighlightBandOrthogonalScroll()},this._selectorListener=function(){self._onHighlightBandScroll()};var inputDiv=this._timeline.getDocument().createElement("div");inputDiv.className="timeline-band-input",this._timeline.addDiv(inputDiv),this._keyboardInput=document.createElement("input"),this._keyboardInput.type="text",inputDiv.appendChild(this._keyboardInput),jQuery(this._keyboardInput).on("keyup",function(evt){self._onKeyUp(evt)}),jQuery(this._keyboardInput).on("keydown",function(evt){self._onKeyDown(evt)}),this._div=this._timeline.getDocument().createElement("div"),this._div.id="timeline-band-"+index,this._div.className="timeline-band timeline-band-"+index,this._timeline.addDiv(this._div),jQuery(this._div).on("vmousedown",function(evt){self._onMouseDown(evt)}),jQuery(this._div).on("dblclick",function(evt){self._onDblClick(evt)}),jQuery(document.body).on("vmouseup",function(evt){self._onMouseUp(evt)}),jQuery(document.body).on("vmousemove",function(evt){self._onMouseMove(evt)}),jQuery(document.body).on("mouseleave",function(evt){self._onMouseLeave(evt)});var mouseWheel=null!=this._theme?this._theme.mouseWheel:"scroll";("zoom"===mouseWheel||"scroll"===mouseWheel||this._zoomSteps)&&jQuery(this._div).mousewheel(function(evt){self._onMouseScroll(evt,self._div)}),this._innerDiv=this._timeline.getDocument().createElement("div"),this._innerDiv.className="timeline-band-inner",this._div.appendChild(this._innerDiv),this._ether=bandInfo.ether,bandInfo.ether.initialize(this,timeline),this._etherPainter=bandInfo.etherPainter,bandInfo.etherPainter.initialize(this,timeline),this._eventSource=bandInfo.eventSource,this._eventSource&&(this._eventListener={onAddMany:function(){b._onAddMany()},onClear:function(){b._onClear()}},this._eventSource.addListener(this._eventListener)),this._eventPainter=bandInfo.eventPainter,this._eventTracksNeeded=0,this._eventTrackIncrement=0,bandInfo.eventPainter.initialize(this,timeline),this._decorators="decorators"in bandInfo?bandInfo.decorators:[];for(var i=0;this._decorators.length>i;i++)this._decorators[i].initialize(this,timeline);if(this._supportsOrthogonalScrolling="supportsOrthogonalScrolling"in this._eventPainter&&this._eventPainter.supportsOrthogonalScrolling(),this._supportsOrthogonalScrolling){this._scrollBar=this._timeline.getDocument().createElement("div"),this._scrollBar.id="timeline-band-scrollbar-"+index,this._scrollBar.className="timeline-band-scrollbar",this._timeline.addDiv(this._scrollBar),this._scrollBar.innerHTML='<div class="timeline-band-scrollbar-thumb"> </div>';var scrollbarThumb=this._scrollBar.firstChild;scrollbarThumb.style.cursor="-webkit-grab",jQuery(scrollbarThumb).on("mousedown",function(evt){self._onScrollBarMouseDown(evt)})}},Timeline._Band.SCROLL_MULTIPLES=5,Timeline._Band.prototype.dispose=function(){this.closeBubble(),this._eventSource&&(this._eventSource.removeListener(this._eventListener),this._eventListener=null,this._eventSource=null),this._timeline=null,this._bandInfo=null,this._labeller=null,this._ether=null,this._etherPainter=null,this._eventPainter=null,this._decorators=null,this._onScrollListeners=null,this._syncWithBandHandler=null,this._syncWithBandOrthogonalScrollHandler=null,this._selectorListener=null,this._div=null,this._innerDiv=null,this._keyboardInput=null,this._scrollBar=null},Timeline._Band.prototype.addListener=function(type,listener){jQuery(this).bind(type,listener)},Timeline._Band.prototype.removeListener=function(type,listener){jQuery(this).unbind(type,listener)},Timeline._Band.prototype.setSyncWithBand=function(band,highlight){this._syncWithBand&&(this._syncWithBand.removeListener("scroll",this._syncWithBandHandler),this._syncWithBand.removeListener("orthogonalscroll",this._syncWithBandOrthogonalScrollHandler)),this._syncWithBand=band,this._syncWithBand.addListener("scroll",this._syncWithBandHandler),this._syncWithBand.addListener("orthogonalscroll",this._syncWithBandOrthogonalScrollHandler),this._highlight=highlight,this._positionHighlight()},Timeline._Band.prototype.getLocale=function(){return this._locale},Timeline._Band.prototype.getTimeZone=function(){return this._timeZone},Timeline._Band.prototype.getLabeller=function(){return this._labeller},Timeline._Band.prototype.getIndex=function(){return this._index},Timeline._Band.prototype.getEther=function(){return this._ether},Timeline._Band.prototype.getEtherPainter=function(){return this._etherPainter},Timeline._Band.prototype.getEventSource=function(){return this._eventSource},Timeline._Band.prototype.getEventPainter=function(){return this._eventPainter},Timeline._Band.prototype.getTimeline=function(){return this._timeline},Timeline._Band.prototype.updateEventTrackInfo=function(tracks,increment){this._eventTrackIncrement=increment,tracks>this._eventTracksNeeded&&(this._eventTracksNeeded=tracks)},Timeline._Band.prototype.checkAutoWidth=function(){if(this._timeline.autoWidth){var overviewBand="overview"==this._eventPainter.getType(),margin=overviewBand?this._theme.event.overviewTrack.autoWidthMargin:this._theme.event.track.autoWidthMargin,desiredWidth=Math.ceil((this._eventTracksNeeded+margin)*this._eventTrackIncrement);desiredWidth+=overviewBand?this._theme.event.overviewTrack.offset:this._theme.event.track.offset;var bandInfo=this._bandInfo;desiredWidth!=bandInfo.width&&(bandInfo.width=desiredWidth)}},Timeline._Band.prototype.layout=function(){this.paint()},Timeline._Band.prototype.paint=function(){this._etherPainter.paint(),this._paintDecorators(),this._paintEvents()},Timeline._Band.prototype.softLayout=function(){this.softPaint()},Timeline._Band.prototype.softPaint=function(){this._etherPainter.softPaint(),this._softPaintDecorators(),this._softPaintEvents()},Timeline._Band.prototype.setBandShiftAndWidth=function(shift,width){var inputDiv=this._keyboardInput.parentNode,middle=shift+Math.floor(width/2);this._timeline.isHorizontal()?(this._div.style.top=shift+"px",this._div.style.height=width+"px",inputDiv.style.top=middle+"px",inputDiv.style.left="-1em"):(this._div.style.left=shift+"px",this._div.style.width=width+"px",inputDiv.style.left=middle+"px",inputDiv.style.top="-1em")},Timeline._Band.prototype.getViewWidth=function(){return this._timeline.isHorizontal()?this._div.offsetHeight:this._div.offsetWidth},Timeline._Band.prototype.setViewLength=function(length){this._viewLength=length,this._recenterDiv(),this._onChanging()},Timeline._Band.prototype.getViewLength=function(){return this._viewLength},Timeline._Band.prototype.getTotalViewLength=function(){return Timeline._Band.SCROLL_MULTIPLES*this._viewLength},Timeline._Band.prototype.getViewOffset=function(){return this._viewOffset},Timeline._Band.prototype.getMinDate=function(){return this._ether.pixelOffsetToDate(this._viewOffset)},Timeline._Band.prototype.getMaxDate=function(){return this._ether.pixelOffsetToDate(this._viewOffset+Timeline._Band.SCROLL_MULTIPLES*this._viewLength)},Timeline._Band.prototype.getMinVisibleDate=function(){return this._ether.pixelOffsetToDate(0)},Timeline._Band.prototype.getMinVisibleDateAfterDelta=function(delta){return this._ether.pixelOffsetToDate(delta)},Timeline._Band.prototype.getMaxVisibleDate=function(){return this._ether.pixelOffsetToDate(this._viewLength)},Timeline._Band.prototype.getMaxVisibleDateAfterDelta=function(delta){return this._ether.pixelOffsetToDate(this._viewLength+delta)},Timeline._Band.prototype.getCenterVisibleDate=function(){return this._ether.pixelOffsetToDate(this._viewLength/2)},Timeline._Band.prototype.setMinVisibleDate=function(date){this._changing||this._moveEther(Math.round(-this._ether.dateToPixelOffset(date)))},Timeline._Band.prototype.setMaxVisibleDate=function(date){this._changing||this._moveEther(Math.round(this._viewLength-this._ether.dateToPixelOffset(date)))},Timeline._Band.prototype.setCenterVisibleDate=function(date){this._changing||this._moveEther(Math.round(this._viewLength/2-this._ether.dateToPixelOffset(date)))},Timeline._Band.prototype.dateToPixelOffset=function(date){return this._ether.dateToPixelOffset(date)-this._viewOffset},Timeline._Band.prototype.pixelOffsetToDate=function(pixels){return this._ether.pixelOffsetToDate(pixels-this._viewOffset)},Timeline._Band.prototype.getViewOrthogonalOffset=function(){return this._viewOrthogonalOffset},Timeline._Band.prototype.setViewOrthogonalOffset=function(offset){this._viewOrthogonalOffset=Math.max(0,offset)},Timeline._Band.prototype.createLayerDiv=function(zIndex,className){var div=this._timeline.getDocument().createElement("div");div.className="timeline-band-layer"+("string"==typeof className?" "+className:""),div.style.zIndex=zIndex,this._innerDiv.appendChild(div);var innerDiv=this._timeline.getDocument().createElement("div");return innerDiv.className="timeline-band-layer-inner",innerDiv.style.cursor="-webkit-grab",div.appendChild(innerDiv),innerDiv},Timeline._Band.prototype.removeLayerDiv=function(div){this._innerDiv.removeChild(div.parentNode)},Timeline._Band.prototype.scrollToCenter=function(date,f){this._autoScroll(Math.round(this._viewLength/2-this._ether.dateToPixelOffset(date)),f)},Timeline._Band.prototype.showBubbleForEvent=function(eventID){var evt=this.getEventSource().getEvent(eventID);if(evt){var self=this;this.scrollToCenter(evt.getStart(),function(){self._eventPainter.showBubble(evt)})}},Timeline._Band.prototype.zoom=function(zoomIn,x){if(this._zoomSteps){void 0==x&&(x=-this._viewOffset+this._viewLength/2),x+=this._viewOffset;var zoomDate=this._ether.pixelOffsetToDate(x),netIntervalChange=this._ether.zoom(zoomIn);this._etherPainter.zoom(netIntervalChange),this._moveEther(Math.round(-this._ether.dateToPixelOffset(zoomDate))),this._moveEther(x)}},Timeline._Band.prototype._momentum=function(){var self=this,friction=this._friction;self._dragSpeed=self._dragSpeed*friction;var run=function(){self._moveEther(Math.round(20*-self._dragSpeed)),Math.abs(20*self._dragSpeed)>1?self._momentum():self._dragSpeed=0};window.setTimeout(run,20)},Timeline._Band.prototype._onMouseDown=function(evt){for(var i=0;this._timeline._bands.length>i;i++)this._timeline._bands[i]._dragSpeed=0;return this._dragging?void 0:(this.closeBubble(),this._fireOnEvent("dragstart"),this._dragging=!0,this._dragX=evt.clientX,this._dragY=evt.clientY,this._div.style.cursor="-webkit-grabbing",evt.preventDefault(),!1)},Timeline._Band.prototype._onMouseMove=function(evt){if(this._dragging||this._orthogonalDragging){var diffX=evt.clientX-this._dragX,diffY=evt.clientY-this._dragY,diffTime=this._now-(this._now=(new Date).getTime());this._dragSpeed=this._timeline.isHorizontal()?diffX/diffTime:diffY/diffTime,this._dragX=evt.clientX,this._dragY=evt.clientY,this._fireOnEvent("drag")}if(this._dragging)this._timeline.isHorizontal()?this._moveEther(diffX,diffY):this._moveEther(diffY,diffX);else{if(!this._orthogonalDragging)return;var viewWidth=this.getViewWidth(),scrollbarThumb=this._scrollBar.firstChild;this._timeline.isHorizontal()?this._moveEther(0,-diffY*viewWidth/scrollbarThumb.offsetHeight):this._moveEther(0,-diffX*viewWidth/scrollbarThumb.offsetWidth)}return this._positionHighlight(),this._showScrollbar(),evt.preventDefault(),!1},Timeline._Band.prototype._onMouseUp=function(evt){if(this._dragging)this._dragging=!1,this._fireOnEvent("dragend");else{if(!this._orthogonalDragging)return;this._orthogonalDragging=!1}return this._div.style.cursor="-webkit-grab",Math.abs(this._dragSpeed)>.2&&this._momentum(),this._keyboardInput.focus(),this._bounceBack(),evt.preventDefault(),!1},Timeline._Band.prototype._onMouseLeave=function(evt){if(this._dragging)this._dragging=!1,this._fireOnEvent("dragend");else{if(!this._orthogonalDragging)return;this._orthogonalDragging=!1}return this._div.style.cursor="-webkit-grab",Math.abs(this._dragSpeed)>.2&&this._momentum(),this._keyboardInput.focus(),this._bounceBack(),evt.preventDefault(),!1},Timeline._Band.prototype._onMouseOut=function(evt){if(this._dragging)this._dragging=!1;else{if(!this._orthogonalDragging)return;this._orthogonalDragging=!1}return this._bounceBack(),evt.preventDefault(),!1},Timeline._Band.prototype._onScrollBarMouseDown=function(elmt,evt){return this._orthogonalDragging?void 0:(this.closeBubble(),this._orthogonalDragging=!0,this._dragX=evt.clientX,this._dragY=evt.clientY,evt.preventDefault(),!1)},Timeline._Band.prototype._onMouseScroll=function(evt,innerFrame){var now=new Date;if(now=now.getTime(),!this._lastScrollTime||now-this._lastScrollTime>50){this._lastScrollTime=now;var delta=0;evt.wheelDelta?delta=evt.wheelDelta/120:evt.detail&&(delta=-evt.detail/3);var mouseWheel=this._theme.mouseWheel;if(this._zoomSteps||"zoom"===mouseWheel){if(0!=delta){var zoomIn;delta>0&&(zoomIn=!0),0>delta&&(zoomIn=!1),this._timeline.zoom(zoomIn,evt.pageX-innerFrame.getClientBoundingRect().x,evt.pageY-innerFrame.getClientBoundingRect().y,innerFrame)}}else if("scroll"===mouseWheel){var move_amt=50*(0>delta?-1:1);this._moveEther(move_amt)}}evt.stopPropagation&&evt.stopPropagation(),evt.cancelBubble=!0,evt.preventDefault&&evt.preventDefault(),evt.returnValue=!1},Timeline._Band.prototype._onDblClick=function(evt){var distance=evt.pageX-this._div.getBoundingClientRect().x-(this._viewLength/2-this._viewOffset);this._autoScroll(-distance)},Timeline._Band.prototype._onKeyDown=function(evt){if(!this._dragging){switch(evt.keyCode){case 27:break;case 37:case 38:this._scrollSpeed=Math.min(50,Math.abs(1.05*this._scrollSpeed)),this._moveEther(this._scrollSpeed);break;case 39:case 40:this._scrollSpeed=-Math.min(50,Math.abs(1.05*this._scrollSpeed)),this._moveEther(this._scrollSpeed);break;default:return!0}return this.closeBubble(),evt.preventDefault(),!1}return!0},Timeline._Band.prototype._onKeyUp=function(evt){if(!this._dragging){switch(this._scrollSpeed=this._originalScrollSpeed,evt.keyCode){case 35:this.setCenterVisibleDate(this._eventSource.getLatestDate());break;case 36:this.setCenterVisibleDate(this._eventSource.getEarliestDate());break;case 33:this._autoScroll(this._timeline.getPixelLength());break;case 34:this._autoScroll(-this._timeline.getPixelLength());break;default:return!0}return this.closeBubble(),evt.preventDefault(),!1}return!0},Timeline._Band.prototype._autoScroll=function(distance,f){var b=this,a=Timeline.Graphics.createAnimation(function(abs,diff){b._moveEther(diff)},0,distance,1e3,f);a.run()},Timeline._Band.prototype._moveEther=function(shift,orthogonalShift){void 0===orthogonalShift&&(orthogonalShift=0),this.closeBubble(),this._timeline.shiftOK(this._index,shift)&&(this._viewOffset+=shift,this._ether.shiftPixels(-shift),this._timeline.isHorizontal()?this._div.style.left=this._viewOffset+"px":this._div.style.top=this._viewOffset+"px",this._supportsOrthogonalScrolling&&(this._viewOrthogonalOffset=this._eventPainter.getOrthogonalExtent()<=this.getViewWidth()?0:this._viewOrthogonalOffset+orthogonalShift),this._viewOffset>.5*-this._viewLength||this._viewOffset<-this._viewLength*(Timeline._Band.SCROLL_MULTIPLES-1.5)?this._recenterDiv():this.softLayout(),this._changingMod=(this._changingMod+1)%10,0==this._changingMod&&this._onChanging())},Timeline._Band.prototype._changingMod=0,Timeline._Band.prototype._onChanging=function(){this._changing=!0,this._fireOnEvent("scroll"),this._setSyncWithBandDate(),this._changing=!1},Timeline._Band.prototype.busy=function(){return this._changing},Timeline._Band.prototype._fireOnEvent=function(type){jQuery(this).trigger(type)},Timeline._Band.prototype._setSyncWithBandDate=function(){if(this._syncWithBand){var centerDate=this._ether.pixelOffsetToDate(this.getViewLength()/2);this._syncWithBand.setCenterVisibleDate(centerDate)}},Timeline._Band.prototype._onHighlightBandScroll=function(){if(this._syncWithBand){var centerDate=this._syncWithBand.getCenterVisibleDate(),centerPixelOffset=this._ether.dateToPixelOffset(centerDate);this._moveEther(Math.round(this._viewLength/2-centerPixelOffset)),this._positionHighlight()}},Timeline._Band.prototype._onHighlightBandOrthogonalScroll=function(){this._syncWithBand&&this._positionHighlight()},Timeline._Band.prototype._onAddMany=function(){this._paintEvents()},Timeline._Band.prototype._onClear=function(){this._paintEvents()},Timeline._Band.prototype._positionHighlight=function(){if(this._syncWithBand){var startDate=this._syncWithBand.getMinVisibleDate(),endDate=this._syncWithBand.getMaxVisibleDate();if(this._highlight){var offset=0,extent=1,syncEventPainter=this._syncWithBand.getEventPainter();if("supportsOrthogonalScrolling"in syncEventPainter&&syncEventPainter.supportsOrthogonalScrolling()){var orthogonalExtent=syncEventPainter.getOrthogonalExtent(),visibleWidth=this._syncWithBand.getViewWidth(),totalWidth=Math.max(visibleWidth,orthogonalExtent);extent=visibleWidth/totalWidth,offset=-this._syncWithBand.getViewOrthogonalOffset()/totalWidth}this._etherPainter.setHighlight(startDate,endDate,offset,extent)}}},Timeline._Band.prototype._recenterDiv=function(){this._viewOffset=-this._viewLength*(Timeline._Band.SCROLL_MULTIPLES-1)/2,this._timeline.isHorizontal()?(this._div.style.left=this._viewOffset+"px",this._div.style.width=Timeline._Band.SCROLL_MULTIPLES*this._viewLength+"px"):(this._div.style.top=this._viewOffset+"px",this._div.style.height=Timeline._Band.SCROLL_MULTIPLES*this._viewLength+"px"),this.layout()},Timeline._Band.prototype._paintEvents=function(){this._eventPainter.paint(),this._showScrollbar(),this._fireOnEvent("orthogonalscroll")},Timeline._Band.prototype._softPaintEvents=function(){this._eventPainter.softPaint()},Timeline._Band.prototype._paintDecorators=function(){for(var i=0;this._decorators.length>i;i++)this._decorators[i].paint()},Timeline._Band.prototype._softPaintDecorators=function(){for(var i=0;this._decorators.length>i;i++)this._decorators[i].softPaint()},Timeline._Band.prototype.closeBubble=function(){},Timeline._Band.prototype._bounceBack=function(){if(this._supportsOrthogonalScrolling){var target=0;if(0>this._viewOrthogonalOffset){var orthogonalExtent=this._eventPainter.getOrthogonalExtent();target=this._viewOrthogonalOffset+orthogonalExtent>=this.getViewWidth()?this._viewOrthogonalOffset:Math.min(0,this.getViewWidth()-orthogonalExtent)}if(target!=this._viewOrthogonalOffset){var self=this;Timeline.Graphics.createAnimation(function(abs){self._viewOrthogonalOffset=abs,self._eventPainter.softPaint(),self._showScrollbar(),self._fireOnEvent("orthogonalscroll")},this._viewOrthogonalOffset,target,300,function(){self._hideScrollbar()}).run()}else this._hideScrollbar()}},Timeline._Band.prototype._showScrollbar=function(){if(this._supportsOrthogonalScrolling){var orthogonalExtent=this._eventPainter.getOrthogonalExtent(),visibleWidth=this.getViewWidth(),totalWidth=Math.max(visibleWidth,orthogonalExtent),ratio=visibleWidth/totalWidth,thumbWidth=Math.round(visibleWidth*ratio)+"px",thumbOffset=Math.round(-this._viewOrthogonalOffset*ratio)+"px",thumbThickness=12,thumb=this._scrollBar.firstChild;this._timeline.isHorizontal()?(this._scrollBar.style.top=this._div.style.top,this._scrollBar.style.height=this._div.style.height,this._scrollBar.style.right="0px",this._scrollBar.style.width=thumbThickness+"px",thumb.style.top=thumbOffset,thumb.style.height=thumbWidth):(this._scrollBar.style.left=this._div.style.left,this._scrollBar.style.width=this._div.style.width,this._scrollBar.style.bottom="0px",this._scrollBar.style.height=thumbThickness+"px",thumb.style.left=thumbOffset,thumb.style.width=thumbWidth),this._scrollBar.style.display=ratio>=1&&0==this._viewOrthogonalOffset?"none":"block"}},Timeline._Band.prototype._hideScrollbar=function(){!this._supportsOrthogonalScrolling},Timeline._Band.prototype.centerOnEvents=function(animate){var earliestEvent=this._eventSource.getEarliestDate(),latestEvent=this._eventSource.getLatestDate();if(latestEvent&&earliestEvent)for(var eventsTimespan=latestEvent.getTime()-earliestEvent.getTime(),eventsCenter=new Date(earliestEvent.getTime()+eventsTimespan/2),i=0;this._zoomSteps.length>i;i++){var bandTimespan=this.getViewLength()/this._zoomSteps[i].pixelsPerInterval*Timeline.DateTime.gregorianUnitLengths[this._zoomSteps[i].unit];if(bandTimespan>=eventsTimespan)return this.zoom(i),this.paint(),animate?this.scrollToCenter(eventsCenter):this.setCenterVisibleDate(eventsCenter),void 0}};